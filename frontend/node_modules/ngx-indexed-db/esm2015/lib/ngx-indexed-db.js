/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
export class NgxIndexedDB {
    /**
     * @param {?} dbName
     * @param {?} version
     */
    constructor(dbName, version) {
        this.utils = new Utils();
        this.dbWrapper = new DbWrapper(dbName, version);
    }
    /**
     * @param {?} version
     * @param {?=} upgradeCallback
     * @return {?}
     */
    openDatabase(version, upgradeCallback) {
        return new Promise((resolve, reject) => {
            this.dbWrapper.dbVersion = version;
            /** @type {?} */
            let request = this.utils.indexedDB.open(this.dbWrapper.dbName, version);
            request.onsuccess = e => {
                this.dbWrapper.db = request.result;
                resolve();
            };
            request.onerror = e => {
                reject('IndexedDB error: ' + (/** @type {?} */ (e.target)).errorCode
                    ? (/** @type {?} */ (e.target)).errorCode + ' (' + (/** @type {?} */ (e.target)).error + ')'
                    : (/** @type {?} */ (e.target)).errorCode);
            };
            if (typeof upgradeCallback === 'function') {
                request.onupgradeneeded = e => {
                    upgradeCallback(e, this.dbWrapper.db);
                };
            }
        });
    }
    /**
     * @param {?} storeName
     * @param {?} key
     * @return {?}
     */
    getByKey(storeName, key) {
        return new Promise((resolve, reject) => {
            this.dbWrapper.validateBeforeTransaction(storeName, reject);
            /** @type {?} */
            let transaction = this.dbWrapper.createTransaction(this.dbWrapper.optionsGenerator(DBMode.readonly, storeName, reject, resolve));
            /** @type {?} */
            let objectStore = transaction.objectStore(storeName);
            /** @type {?} */
            let request;
            request = objectStore.get(key);
            request.onsuccess = function (event) {
                resolve((/** @type {?} */ (event.target)).result);
            };
        });
    }
    /**
     * @param {?} storeName
     * @param {?=} keyRange
     * @param {?=} indexDetails
     * @return {?}
     */
    getAll(storeName, keyRange, indexDetails) {
        return new Promise((resolve, reject) => {
            this.dbWrapper.validateBeforeTransaction(storeName, reject);
            /** @type {?} */
            let transaction = this.dbWrapper.createTransaction(this.dbWrapper.optionsGenerator(DBMode.readonly, storeName, reject, resolve));
            /** @type {?} */
            let objectStore = transaction.objectStore(storeName);
            /** @type {?} */
            let result = [];
            /** @type {?} */
            let request;
            if (indexDetails) {
                /** @type {?} */
                let index = objectStore.index(indexDetails.indexName);
                /** @type {?} */
                let order = indexDetails.order === 'desc' ? 'prev' : 'next';
                request = index.openCursor(keyRange, /** @type {?} */ (order));
            }
            else {
                request = objectStore.openCursor(keyRange);
            }
            request.onerror = function (e) {
                reject(e);
            };
            request.onsuccess = function (evt) {
                /** @type {?} */
                let cursor = (/** @type {?} */ (evt.target)).result;
                if (cursor) {
                    result.push(cursor['value']);
                    cursor['continue']();
                }
                else {
                    resolve(result);
                }
            };
        });
    }
    /**
     * @param {?} storeName
     * @param {?} value
     * @param {?=} key
     * @return {?}
     */
    add(storeName, value, key) {
        return new Promise((resolve, reject) => {
            this.dbWrapper.validateBeforeTransaction(storeName, reject);
            /** @type {?} */
            let transaction = this.dbWrapper.createTransaction(this.dbWrapper.optionsGenerator(DBMode.readwrite, storeName, reject, resolve));
            /** @type {?} */
            let objectStore = transaction.objectStore(storeName);
            /** @type {?} */
            let request = objectStore.add(value, key);
            request.onsuccess = (evt) => {
                key = evt.target.result;
            };
        });
    }
    /**
     * @param {?} storeName
     * @param {?} value
     * @param {?=} key
     * @return {?}
     */
    update(storeName, value, key) {
        return new Promise((resolve, reject) => {
            this.dbWrapper.validateBeforeTransaction(storeName, reject);
            /** @type {?} */
            let transaction = this.dbWrapper.createTransaction(this.dbWrapper.optionsGenerator(DBMode.readwrite, storeName, reject, resolve));
            /** @type {?} */
            let objectStore = transaction.objectStore(storeName);
            objectStore.put(value, key);
        });
    }
    /**
     * @param {?} storeName
     * @param {?} key
     * @return {?}
     */
    delete(storeName, key) {
        return new Promise((resolve, reject) => {
            this.dbWrapper.validateBeforeTransaction(storeName, reject);
            /** @type {?} */
            let transaction = this.dbWrapper.createTransaction(this.dbWrapper.optionsGenerator(DBMode.readwrite, storeName, reject, resolve));
            /** @type {?} */
            let objectStore = transaction.objectStore(storeName);
            objectStore['delete'](key);
        });
    }
    /**
     * @param {?} storeName
     * @param {?} cursorCallback
     * @param {?=} keyRange
     * @return {?}
     */
    openCursor(storeName, cursorCallback, keyRange) {
        return new Promise((resolve, reject) => {
            this.dbWrapper.validateBeforeTransaction(storeName, reject);
            /** @type {?} */
            let transaction = this.dbWrapper.createTransaction(this.dbWrapper.optionsGenerator(DBMode.readonly, storeName, reject, resolve));
            /** @type {?} */
            let objectStore = transaction.objectStore(storeName);
            /** @type {?} */
            let request = objectStore.openCursor(keyRange);
            request.onsuccess = (evt) => {
                cursorCallback(evt);
                resolve();
            };
        });
    }
    /**
     * @param {?} storeName
     * @return {?}
     */
    clear(storeName) {
        return new Promise((resolve, reject) => {
            this.dbWrapper.validateBeforeTransaction(storeName, reject);
            /** @type {?} */
            let transaction = this.dbWrapper.createTransaction(this.dbWrapper.optionsGenerator(DBMode.readwrite, storeName, reject, resolve));
            /** @type {?} */
            let objectStore = transaction.objectStore(storeName);
            objectStore.clear();
            resolve();
        });
    }
    /**
     * @param {?} storeName
     * @param {?} indexName
     * @param {?} key
     * @return {?}
     */
    getByIndex(storeName, indexName, key) {
        return new Promise((resolve, reject) => {
            this.dbWrapper.validateBeforeTransaction(storeName, reject);
            /** @type {?} */
            let transaction = this.dbWrapper.createTransaction(this.dbWrapper.optionsGenerator(DBMode.readonly, storeName, reject, resolve));
            /** @type {?} */
            let objectStore = transaction.objectStore(storeName);
            /** @type {?} */
            let index = objectStore.index(indexName);
            /** @type {?} */
            let request = index.get(key);
            request.onsuccess = event => {
                resolve((/** @type {?} */ (event.target)).result);
            };
        });
    }
}
if (false) {
    /** @type {?} */
    NgxIndexedDB.prototype.utils;
    /** @type {?} */
    NgxIndexedDB.prototype.dbWrapper;
}
export class Utils {
    constructor() {
        this.indexedDB =
            window.indexedDB ||
                (/** @type {?} */ (window)).mozIndexedDB ||
                (/** @type {?} */ (window)).webkitIndexedDB ||
                (/** @type {?} */ (window)).msIndexedDB;
    }
}
if (false) {
    /** @type {?} */
    Utils.prototype.indexedDB;
}
/**
 * @record
 */
export function IndexDetails() { }
/** @type {?} */
IndexDetails.prototype.indexName;
/** @type {?} */
IndexDetails.prototype.order;
export class DbWrapper {
    /**
     * @param {?} dbName
     * @param {?} version
     */
    constructor(dbName, version) {
        this.dbName = dbName;
        this.dbVersion = version || 1;
    }
    /**
     * @param {?} storeName
     * @return {?}
     */
    validateStoreName(storeName) {
        return this.db.objectStoreNames.contains(storeName);
    }
    /**
     * @param {?} storeName
     * @param {?} reject
     * @return {?}
     */
    validateBeforeTransaction(storeName, reject) {
        if (!this.db) {
            reject('You need to use the openDatabase function to create a database before you query it!');
        }
        if (!this.validateStoreName(storeName)) {
            reject('objectStore does not exists: ' + storeName);
        }
    }
    /**
     * @param {?} options
     * @return {?}
     */
    createTransaction(options) {
        /** @type {?} */
        let trans = this.db.transaction(options.storeName, options.dbMode);
        trans.onerror = options.error;
        trans.oncomplete = options.complete;
        trans.onabort = options.abort;
        return trans;
    }
    /**
     * @param {?} type
     * @param {?} storeName
     * @param {?} reject
     * @param {?} resolve
     * @return {?}
     */
    optionsGenerator(type, storeName, reject, resolve) {
        return {
            storeName: storeName,
            dbMode: type,
            error: (e) => {
                reject(e);
            },
            complete: (e) => {
                resolve();
            },
            abort: (e) => {
                reject(e);
            }
        };
    }
}
if (false) {
    /** @type {?} */
    DbWrapper.prototype.dbName;
    /** @type {?} */
    DbWrapper.prototype.dbVersion;
    /** @type {?} */
    DbWrapper.prototype.db;
}
/**
 * @record
 */
export function Options() { }
/** @type {?} */
Options.prototype.storeName;
/** @type {?} */
Options.prototype.dbMode;
/** @type {?} */
Options.prototype.error;
/** @type {?} */
Options.prototype.complete;
/** @type {?|undefined} */
Options.prototype.abort;
/** @enum {string} */
const DBMode = {
    readonly: 'readonly',
    readwrite: 'readwrite',
};
export { DBMode };

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LWluZGV4ZWQtZGIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtaW5kZXhlZC1kYi8iLCJzb3VyY2VzIjpbImxpYi9uZ3gtaW5kZXhlZC1kYi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTTs7Ozs7SUFJTCxZQUFZLE1BQWMsRUFBRSxPQUFlO1FBQzFDLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxLQUFLLEVBQUUsQ0FBQztRQUN6QixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksU0FBUyxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztLQUNoRDs7Ozs7O0lBRUQsWUFBWSxDQUFDLE9BQWUsRUFBRSxlQUEwQjtRQUN2RCxNQUFNLENBQUMsSUFBSSxPQUFPLENBQU0sQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDM0MsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLEdBQUcsT0FBTyxDQUFDOztZQUNuQyxJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDeEUsT0FBTyxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUMsRUFBRTtnQkFDdkIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQztnQkFDbkMsT0FBTyxFQUFFLENBQUM7YUFDVixDQUFDO1lBRUYsT0FBTyxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUMsRUFBRTtnQkFDckIsTUFBTSxDQUNMLG1CQUFtQixHQUFHLG1CQUFNLENBQUMsQ0FBQyxNQUFNLEVBQUMsQ0FBQyxTQUFTO29CQUM5QyxDQUFDLENBQUMsbUJBQU0sQ0FBQyxDQUFDLE1BQU0sRUFBQyxDQUFDLFNBQVMsR0FBRyxJQUFJLEdBQUcsbUJBQU0sQ0FBQyxDQUFDLE1BQU0sRUFBQyxDQUFDLEtBQUssR0FBRyxHQUFHO29CQUNoRSxDQUFDLENBQUMsbUJBQU0sQ0FBQyxDQUFDLE1BQU0sRUFBQyxDQUFDLFNBQVMsQ0FDNUIsQ0FBQzthQUNGLENBQUM7WUFFRixFQUFFLENBQUMsQ0FBQyxPQUFPLGVBQWUsS0FBSyxVQUFVLENBQUMsQ0FBQyxDQUFDO2dCQUMzQyxPQUFPLENBQUMsZUFBZSxHQUFHLENBQUMsQ0FBQyxFQUFFO29CQUM3QixlQUFlLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLENBQUM7aUJBQ3RDLENBQUM7YUFDRjtTQUNELENBQUMsQ0FBQztLQUNIOzs7Ozs7SUFFRCxRQUFRLENBQUMsU0FBaUIsRUFBRSxHQUFRO1FBQ25DLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBTSxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUMzQyxJQUFJLENBQUMsU0FBUyxDQUFDLHlCQUF5QixDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUMsQ0FBQzs7WUFFNUQsSUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsQ0FDaEQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQzVFLENBRW1COztZQUpyQixJQUdDLFdBQVcsR0FBRyxXQUFXLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUM1Qjs7WUFKckIsSUFJQyxPQUFPLENBQWE7WUFFckIsT0FBTyxHQUFHLFdBQVcsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDL0IsT0FBTyxDQUFDLFNBQVMsR0FBRyxVQUFTLEtBQVk7Z0JBQ3hDLE9BQU8sQ0FBQyxtQkFBTSxLQUFLLENBQUMsTUFBTSxFQUFDLENBQUMsTUFBTSxDQUFDLENBQUM7YUFDcEMsQ0FBQztTQUNGLENBQUMsQ0FBQztLQUNIOzs7Ozs7O0lBRUQsTUFBTSxDQUFDLFNBQWlCLEVBQUUsUUFBc0IsRUFBRSxZQUEyQjtRQUM1RSxNQUFNLENBQUMsSUFBSSxPQUFPLENBQU0sQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDM0MsSUFBSSxDQUFDLFNBQVMsQ0FBQyx5QkFBeUIsQ0FBQyxTQUFTLEVBQUUsTUFBTSxDQUFDLENBQUM7O1lBRTVELElBQUksV0FBVyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsaUJBQWlCLENBQ2hELElBQUksQ0FBQyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUM1RSxDQUdtQjs7WUFMckIsSUFHQyxXQUFXLEdBQUcsV0FBVyxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FFNUI7O1lBTHJCLElBSUMsTUFBTSxHQUFlLEVBQUUsQ0FDSDs7WUFMckIsSUFLQyxPQUFPLENBQWE7WUFDckIsRUFBRSxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQzs7Z0JBQ2xCLElBQUksS0FBSyxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUNJOztnQkFEekQsSUFDQyxLQUFLLEdBQUcsWUFBWSxDQUFDLEtBQUssS0FBSyxNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO2dCQUN6RCxPQUFPLEdBQUcsS0FBSyxDQUFDLFVBQVUsQ0FBQyxRQUFRLG9CQUFzQixLQUFLLEVBQUMsQ0FBQzthQUNoRTtZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNQLE9BQU8sR0FBRyxXQUFXLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQzNDO1lBRUQsT0FBTyxDQUFDLE9BQU8sR0FBRyxVQUFTLENBQUM7Z0JBQzNCLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUNWLENBQUM7WUFFRixPQUFPLENBQUMsU0FBUyxHQUFHLFVBQVMsR0FBVTs7Z0JBQ3RDLElBQUksTUFBTSxHQUFHLG1CQUFtQixHQUFHLENBQUMsTUFBTSxFQUFDLENBQUMsTUFBTSxDQUFDO2dCQUNuRCxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO29CQUNaLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7b0JBQzdCLE1BQU0sQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDO2lCQUNyQjtnQkFBQyxJQUFJLENBQUMsQ0FBQztvQkFDUCxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7aUJBQ2hCO2FBQ0QsQ0FBQztTQUNGLENBQUMsQ0FBQztLQUNIOzs7Ozs7O0lBRUQsR0FBRyxDQUFDLFNBQWlCLEVBQUUsS0FBVSxFQUFFLEdBQVM7UUFDM0MsTUFBTSxDQUFDLElBQUksT0FBTyxDQUFNLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQzNDLElBQUksQ0FBQyxTQUFTLENBQUMseUJBQXlCLENBQUMsU0FBUyxFQUFFLE1BQU0sQ0FBQyxDQUFDOztZQUM1RCxJQUFJLFdBQVcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLGlCQUFpQixDQUNoRCxJQUFJLENBQUMsU0FBUyxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxTQUFTLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FDN0UsQ0FDZ0Q7O1lBSGxELElBR0MsV0FBVyxHQUFHLFdBQVcsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUM7O1lBRWxELElBQUksT0FBTyxHQUFHLFdBQVcsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQzFDLE9BQU8sQ0FBQyxTQUFTLEdBQUcsQ0FBQyxHQUFRLEVBQUUsRUFBRTtnQkFDaEMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDO2FBQ3hCLENBQUM7U0FDRixDQUFDLENBQUM7S0FDSDs7Ozs7OztJQUVELE1BQU0sQ0FBQyxTQUFpQixFQUFFLEtBQVUsRUFBRSxHQUFTO1FBQzlDLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBTSxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUMzQyxJQUFJLENBQUMsU0FBUyxDQUFDLHlCQUF5QixDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUMsQ0FBQzs7WUFFNUQsSUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsQ0FDaEQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQzdFLENBQ2dEOztZQUhsRCxJQUdDLFdBQVcsR0FBRyxXQUFXLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBRWxELFdBQVcsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1NBQzVCLENBQUMsQ0FBQztLQUNIOzs7Ozs7SUFFRCxNQUFNLENBQUMsU0FBaUIsRUFBRSxHQUFRO1FBQ2pDLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBTSxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUMzQyxJQUFJLENBQUMsU0FBUyxDQUFDLHlCQUF5QixDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUMsQ0FBQzs7WUFFNUQsSUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsQ0FDaEQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQzdFLENBQ2dEOztZQUhsRCxJQUdDLFdBQVcsR0FBRyxXQUFXLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBRWxELFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUMzQixDQUFDLENBQUM7S0FDSDs7Ozs7OztJQUVELFVBQVUsQ0FBQyxTQUFpQixFQUFFLGNBQW9DLEVBQUUsUUFBc0I7UUFDekYsTUFBTSxDQUFDLElBQUksT0FBTyxDQUFNLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQzNDLElBQUksQ0FBQyxTQUFTLENBQUMseUJBQXlCLENBQUMsU0FBUyxFQUFFLE1BQU0sQ0FBQyxDQUFDOztZQUM1RCxJQUFJLFdBQVcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLGlCQUFpQixDQUNoRCxJQUFJLENBQUMsU0FBUyxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FDNUUsQ0FFMEM7O1lBSjVDLElBR0MsV0FBVyxHQUFHLFdBQVcsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQ0w7O1lBSjVDLElBSUMsT0FBTyxHQUFHLFdBQVcsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUM7WUFFNUMsT0FBTyxDQUFDLFNBQVMsR0FBRyxDQUFDLEdBQVUsRUFBRSxFQUFFO2dCQUNsQyxjQUFjLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ3BCLE9BQU8sRUFBRSxDQUFDO2FBQ1YsQ0FBQztTQUNGLENBQUMsQ0FBQztLQUNIOzs7OztJQUVELEtBQUssQ0FBQyxTQUFpQjtRQUN0QixNQUFNLENBQUMsSUFBSSxPQUFPLENBQU0sQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDM0MsSUFBSSxDQUFDLFNBQVMsQ0FBQyx5QkFBeUIsQ0FBQyxTQUFTLEVBQUUsTUFBTSxDQUFDLENBQUM7O1lBQzVELElBQUksV0FBVyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsaUJBQWlCLENBQ2hELElBQUksQ0FBQyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUM3RSxDQUNnRDs7WUFIbEQsSUFHQyxXQUFXLEdBQUcsV0FBVyxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUNsRCxXQUFXLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDcEIsT0FBTyxFQUFFLENBQUM7U0FDVixDQUFDLENBQUM7S0FDSDs7Ozs7OztJQUVELFVBQVUsQ0FBQyxTQUFpQixFQUFFLFNBQWlCLEVBQUUsR0FBUTtRQUN4RCxNQUFNLENBQUMsSUFBSSxPQUFPLENBQU0sQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDM0MsSUFBSSxDQUFDLFNBQVMsQ0FBQyx5QkFBeUIsQ0FBQyxTQUFTLEVBQUUsTUFBTSxDQUFDLENBQUM7O1lBQzVELElBQUksV0FBVyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsaUJBQWlCLENBQ2hELElBQUksQ0FBQyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUM1RSxDQUd3Qjs7WUFMMUIsSUFHQyxXQUFXLEdBQUcsV0FBVyxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FFdkI7O1lBTDFCLElBSUMsS0FBSyxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQ1g7O1lBTDFCLElBS0MsT0FBTyxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7WUFFMUIsT0FBTyxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUMsRUFBRTtnQkFDM0IsT0FBTyxDQUFDLG1CQUFtQixLQUFLLENBQUMsTUFBTSxFQUFDLENBQUMsTUFBTSxDQUFDLENBQUM7YUFDakQsQ0FBQztTQUNGLENBQUMsQ0FBQztLQUNIO0NBQ0Q7Ozs7Ozs7QUFFRCxNQUFNO0lBR0w7UUFDQyxJQUFJLENBQUMsU0FBUztZQUNiLE1BQU0sQ0FBQyxTQUFTO2dCQUNoQixtQkFBTSxNQUFNLEVBQUMsQ0FBQyxZQUFZO2dCQUMxQixtQkFBTSxNQUFNLEVBQUMsQ0FBQyxlQUFlO2dCQUM3QixtQkFBTSxNQUFNLEVBQUMsQ0FBQyxXQUFXLENBQUM7S0FDM0I7Q0FDRDs7Ozs7Ozs7Ozs7OztBQU9ELE1BQU07Ozs7O0lBS0wsWUFBWSxNQUFjLEVBQUUsT0FBZTtRQUMxQyxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsU0FBUyxHQUFHLE9BQU8sSUFBSSxDQUFDLENBQUM7S0FDOUI7Ozs7O0lBRUQsaUJBQWlCLENBQUMsU0FBaUI7UUFDbEMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0tBQ3BEOzs7Ozs7SUFFRCx5QkFBeUIsQ0FBQyxTQUFpQixFQUFFLE1BQWdCO1FBQzVELEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDZCxNQUFNLENBQUMscUZBQXFGLENBQUMsQ0FBQztTQUM5RjtRQUNELEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN4QyxNQUFNLENBQUMsK0JBQStCLEdBQUcsU0FBUyxDQUFDLENBQUM7U0FDcEQ7S0FDRDs7Ozs7SUFFRCxpQkFBaUIsQ0FBQyxPQUFnQjs7UUFDakMsSUFBSSxLQUFLLEdBQW1CLElBQUksQ0FBQyxFQUFFLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ25GLEtBQUssQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQztRQUM5QixLQUFLLENBQUMsVUFBVSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUM7UUFDcEMsS0FBSyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDO1FBQzlCLE1BQU0sQ0FBQyxLQUFLLENBQUM7S0FDYjs7Ozs7Ozs7SUFFRCxnQkFBZ0IsQ0FBQyxJQUFTLEVBQUUsU0FBYyxFQUFFLE1BQWdCLEVBQUUsT0FBaUI7UUFDOUUsTUFBTSxDQUFDO1lBQ04sU0FBUyxFQUFFLFNBQVM7WUFDcEIsTUFBTSxFQUFFLElBQUk7WUFDWixLQUFLLEVBQUUsQ0FBQyxDQUFRLEVBQUUsRUFBRTtnQkFDbkIsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ1Y7WUFDRCxRQUFRLEVBQUUsQ0FBQyxDQUFRLEVBQUUsRUFBRTtnQkFDdEIsT0FBTyxFQUFFLENBQUM7YUFDVjtZQUNELEtBQUssRUFBRSxDQUFDLENBQVEsRUFBRSxFQUFFO2dCQUNuQixNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDVjtTQUNELENBQUM7S0FDRjtDQUNEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0lBV0EsVUFBVyxVQUFVO0lBQ3JCLFdBQVksV0FBVyIsInNvdXJjZXNDb250ZW50IjpbImV4cG9ydCBjbGFzcyBOZ3hJbmRleGVkREIge1xuXHR1dGlsczogVXRpbHM7XG5cdGRiV3JhcHBlcjogRGJXcmFwcGVyO1xuXG5cdGNvbnN0cnVjdG9yKGRiTmFtZTogc3RyaW5nLCB2ZXJzaW9uOiBudW1iZXIpIHtcblx0XHR0aGlzLnV0aWxzID0gbmV3IFV0aWxzKCk7XG5cdFx0dGhpcy5kYldyYXBwZXIgPSBuZXcgRGJXcmFwcGVyKGRiTmFtZSwgdmVyc2lvbik7XG5cdH1cblxuXHRvcGVuRGF0YWJhc2UodmVyc2lvbjogbnVtYmVyLCB1cGdyYWRlQ2FsbGJhY2s/OiBGdW5jdGlvbikge1xuXHRcdHJldHVybiBuZXcgUHJvbWlzZTxhbnk+KChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHRcdHRoaXMuZGJXcmFwcGVyLmRiVmVyc2lvbiA9IHZlcnNpb247XG5cdFx0XHRsZXQgcmVxdWVzdCA9IHRoaXMudXRpbHMuaW5kZXhlZERCLm9wZW4odGhpcy5kYldyYXBwZXIuZGJOYW1lLCB2ZXJzaW9uKTtcblx0XHRcdHJlcXVlc3Qub25zdWNjZXNzID0gZSA9PiB7XG5cdFx0XHRcdHRoaXMuZGJXcmFwcGVyLmRiID0gcmVxdWVzdC5yZXN1bHQ7XG5cdFx0XHRcdHJlc29sdmUoKTtcblx0XHRcdH07XG5cblx0XHRcdHJlcXVlc3Qub25lcnJvciA9IGUgPT4ge1xuXHRcdFx0XHRyZWplY3QoXG5cdFx0XHRcdFx0J0luZGV4ZWREQiBlcnJvcjogJyArICg8YW55PmUudGFyZ2V0KS5lcnJvckNvZGVcblx0XHRcdFx0XHRcdD8gKDxhbnk+ZS50YXJnZXQpLmVycm9yQ29kZSArICcgKCcgKyAoPGFueT5lLnRhcmdldCkuZXJyb3IgKyAnKSdcblx0XHRcdFx0XHRcdDogKDxhbnk+ZS50YXJnZXQpLmVycm9yQ29kZVxuXHRcdFx0XHQpO1xuXHRcdFx0fTtcblxuXHRcdFx0aWYgKHR5cGVvZiB1cGdyYWRlQ2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIHtcblx0XHRcdFx0cmVxdWVzdC5vbnVwZ3JhZGVuZWVkZWQgPSBlID0+IHtcblx0XHRcdFx0XHR1cGdyYWRlQ2FsbGJhY2soZSwgdGhpcy5kYldyYXBwZXIuZGIpO1xuXHRcdFx0XHR9O1xuXHRcdFx0fVxuXHRcdH0pO1xuXHR9XG5cblx0Z2V0QnlLZXkoc3RvcmVOYW1lOiBzdHJpbmcsIGtleTogYW55KSB7XG5cdFx0cmV0dXJuIG5ldyBQcm9taXNlPGFueT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdFx0dGhpcy5kYldyYXBwZXIudmFsaWRhdGVCZWZvcmVUcmFuc2FjdGlvbihzdG9yZU5hbWUsIHJlamVjdCk7XG5cblx0XHRcdGxldCB0cmFuc2FjdGlvbiA9IHRoaXMuZGJXcmFwcGVyLmNyZWF0ZVRyYW5zYWN0aW9uKFxuXHRcdFx0XHRcdHRoaXMuZGJXcmFwcGVyLm9wdGlvbnNHZW5lcmF0b3IoREJNb2RlLnJlYWRvbmx5LCBzdG9yZU5hbWUsIHJlamVjdCwgcmVzb2x2ZSlcblx0XHRcdFx0KSxcblx0XHRcdFx0b2JqZWN0U3RvcmUgPSB0cmFuc2FjdGlvbi5vYmplY3RTdG9yZShzdG9yZU5hbWUpLFxuXHRcdFx0XHRyZXF1ZXN0OiBJREJSZXF1ZXN0O1xuXG5cdFx0XHRyZXF1ZXN0ID0gb2JqZWN0U3RvcmUuZ2V0KGtleSk7XG5cdFx0XHRyZXF1ZXN0Lm9uc3VjY2VzcyA9IGZ1bmN0aW9uKGV2ZW50OiBFdmVudCkge1xuXHRcdFx0XHRyZXNvbHZlKCg8YW55PmV2ZW50LnRhcmdldCkucmVzdWx0KTtcblx0XHRcdH07XG5cdFx0fSk7XG5cdH1cblxuXHRnZXRBbGwoc3RvcmVOYW1lOiBzdHJpbmcsIGtleVJhbmdlPzogSURCS2V5UmFuZ2UsIGluZGV4RGV0YWlscz86IEluZGV4RGV0YWlscykge1xuXHRcdHJldHVybiBuZXcgUHJvbWlzZTxhbnk+KChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHRcdHRoaXMuZGJXcmFwcGVyLnZhbGlkYXRlQmVmb3JlVHJhbnNhY3Rpb24oc3RvcmVOYW1lLCByZWplY3QpO1xuXG5cdFx0XHRsZXQgdHJhbnNhY3Rpb24gPSB0aGlzLmRiV3JhcHBlci5jcmVhdGVUcmFuc2FjdGlvbihcblx0XHRcdFx0XHR0aGlzLmRiV3JhcHBlci5vcHRpb25zR2VuZXJhdG9yKERCTW9kZS5yZWFkb25seSwgc3RvcmVOYW1lLCByZWplY3QsIHJlc29sdmUpXG5cdFx0XHRcdCksXG5cdFx0XHRcdG9iamVjdFN0b3JlID0gdHJhbnNhY3Rpb24ub2JqZWN0U3RvcmUoc3RvcmVOYW1lKSxcblx0XHRcdFx0cmVzdWx0OiBBcnJheTxhbnk+ID0gW10sXG5cdFx0XHRcdHJlcXVlc3Q6IElEQlJlcXVlc3Q7XG5cdFx0XHRpZiAoaW5kZXhEZXRhaWxzKSB7XG5cdFx0XHRcdGxldCBpbmRleCA9IG9iamVjdFN0b3JlLmluZGV4KGluZGV4RGV0YWlscy5pbmRleE5hbWUpLFxuXHRcdFx0XHRcdG9yZGVyID0gaW5kZXhEZXRhaWxzLm9yZGVyID09PSAnZGVzYycgPyAncHJldicgOiAnbmV4dCc7XG5cdFx0XHRcdHJlcXVlc3QgPSBpbmRleC5vcGVuQ3Vyc29yKGtleVJhbmdlLCA8SURCQ3Vyc29yRGlyZWN0aW9uPm9yZGVyKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHJlcXVlc3QgPSBvYmplY3RTdG9yZS5vcGVuQ3Vyc29yKGtleVJhbmdlKTtcblx0XHRcdH1cblxuXHRcdFx0cmVxdWVzdC5vbmVycm9yID0gZnVuY3Rpb24oZSkge1xuXHRcdFx0XHRyZWplY3QoZSk7XG5cdFx0XHR9O1xuXG5cdFx0XHRyZXF1ZXN0Lm9uc3VjY2VzcyA9IGZ1bmN0aW9uKGV2dDogRXZlbnQpIHtcblx0XHRcdFx0bGV0IGN1cnNvciA9ICg8SURCT3BlbkRCUmVxdWVzdD5ldnQudGFyZ2V0KS5yZXN1bHQ7XG5cdFx0XHRcdGlmIChjdXJzb3IpIHtcblx0XHRcdFx0XHRyZXN1bHQucHVzaChjdXJzb3JbJ3ZhbHVlJ10pO1xuXHRcdFx0XHRcdGN1cnNvclsnY29udGludWUnXSgpO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdHJlc29sdmUocmVzdWx0KTtcblx0XHRcdFx0fVxuXHRcdFx0fTtcblx0XHR9KTtcblx0fVxuXG5cdGFkZChzdG9yZU5hbWU6IHN0cmluZywgdmFsdWU6IGFueSwga2V5PzogYW55KSB7XG5cdFx0cmV0dXJuIG5ldyBQcm9taXNlPGFueT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdFx0dGhpcy5kYldyYXBwZXIudmFsaWRhdGVCZWZvcmVUcmFuc2FjdGlvbihzdG9yZU5hbWUsIHJlamVjdCk7XG5cdFx0XHRsZXQgdHJhbnNhY3Rpb24gPSB0aGlzLmRiV3JhcHBlci5jcmVhdGVUcmFuc2FjdGlvbihcblx0XHRcdFx0XHR0aGlzLmRiV3JhcHBlci5vcHRpb25zR2VuZXJhdG9yKERCTW9kZS5yZWFkd3JpdGUsIHN0b3JlTmFtZSwgcmVqZWN0LCByZXNvbHZlKVxuXHRcdFx0XHQpLFxuXHRcdFx0XHRvYmplY3RTdG9yZSA9IHRyYW5zYWN0aW9uLm9iamVjdFN0b3JlKHN0b3JlTmFtZSk7XG5cblx0XHRcdGxldCByZXF1ZXN0ID0gb2JqZWN0U3RvcmUuYWRkKHZhbHVlLCBrZXkpO1xuXHRcdFx0cmVxdWVzdC5vbnN1Y2Nlc3MgPSAoZXZ0OiBhbnkpID0+IHtcblx0XHRcdFx0a2V5ID0gZXZ0LnRhcmdldC5yZXN1bHQ7XG5cdFx0XHR9O1xuXHRcdH0pO1xuXHR9XG5cblx0dXBkYXRlKHN0b3JlTmFtZTogc3RyaW5nLCB2YWx1ZTogYW55LCBrZXk/OiBhbnkpIHtcblx0XHRyZXR1cm4gbmV3IFByb21pc2U8YW55PigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cdFx0XHR0aGlzLmRiV3JhcHBlci52YWxpZGF0ZUJlZm9yZVRyYW5zYWN0aW9uKHN0b3JlTmFtZSwgcmVqZWN0KTtcblxuXHRcdFx0bGV0IHRyYW5zYWN0aW9uID0gdGhpcy5kYldyYXBwZXIuY3JlYXRlVHJhbnNhY3Rpb24oXG5cdFx0XHRcdFx0dGhpcy5kYldyYXBwZXIub3B0aW9uc0dlbmVyYXRvcihEQk1vZGUucmVhZHdyaXRlLCBzdG9yZU5hbWUsIHJlamVjdCwgcmVzb2x2ZSlcblx0XHRcdFx0KSxcblx0XHRcdFx0b2JqZWN0U3RvcmUgPSB0cmFuc2FjdGlvbi5vYmplY3RTdG9yZShzdG9yZU5hbWUpO1xuXG5cdFx0XHRvYmplY3RTdG9yZS5wdXQodmFsdWUsIGtleSk7XG5cdFx0fSk7XG5cdH1cblxuXHRkZWxldGUoc3RvcmVOYW1lOiBzdHJpbmcsIGtleTogYW55KSB7XG5cdFx0cmV0dXJuIG5ldyBQcm9taXNlPGFueT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdFx0dGhpcy5kYldyYXBwZXIudmFsaWRhdGVCZWZvcmVUcmFuc2FjdGlvbihzdG9yZU5hbWUsIHJlamVjdCk7XG5cblx0XHRcdGxldCB0cmFuc2FjdGlvbiA9IHRoaXMuZGJXcmFwcGVyLmNyZWF0ZVRyYW5zYWN0aW9uKFxuXHRcdFx0XHRcdHRoaXMuZGJXcmFwcGVyLm9wdGlvbnNHZW5lcmF0b3IoREJNb2RlLnJlYWR3cml0ZSwgc3RvcmVOYW1lLCByZWplY3QsIHJlc29sdmUpXG5cdFx0XHRcdCksXG5cdFx0XHRcdG9iamVjdFN0b3JlID0gdHJhbnNhY3Rpb24ub2JqZWN0U3RvcmUoc3RvcmVOYW1lKTtcblxuXHRcdFx0b2JqZWN0U3RvcmVbJ2RlbGV0ZSddKGtleSk7XG5cdFx0fSk7XG5cdH1cblxuXHRvcGVuQ3Vyc29yKHN0b3JlTmFtZTogc3RyaW5nLCBjdXJzb3JDYWxsYmFjazogKGV2dDogRXZlbnQpID0+IHZvaWQsIGtleVJhbmdlPzogSURCS2V5UmFuZ2UpIHtcblx0XHRyZXR1cm4gbmV3IFByb21pc2U8YW55PigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cdFx0XHR0aGlzLmRiV3JhcHBlci52YWxpZGF0ZUJlZm9yZVRyYW5zYWN0aW9uKHN0b3JlTmFtZSwgcmVqZWN0KTtcblx0XHRcdGxldCB0cmFuc2FjdGlvbiA9IHRoaXMuZGJXcmFwcGVyLmNyZWF0ZVRyYW5zYWN0aW9uKFxuXHRcdFx0XHRcdHRoaXMuZGJXcmFwcGVyLm9wdGlvbnNHZW5lcmF0b3IoREJNb2RlLnJlYWRvbmx5LCBzdG9yZU5hbWUsIHJlamVjdCwgcmVzb2x2ZSlcblx0XHRcdFx0KSxcblx0XHRcdFx0b2JqZWN0U3RvcmUgPSB0cmFuc2FjdGlvbi5vYmplY3RTdG9yZShzdG9yZU5hbWUpLFxuXHRcdFx0XHRyZXF1ZXN0ID0gb2JqZWN0U3RvcmUub3BlbkN1cnNvcihrZXlSYW5nZSk7XG5cblx0XHRcdHJlcXVlc3Qub25zdWNjZXNzID0gKGV2dDogRXZlbnQpID0+IHtcblx0XHRcdFx0Y3Vyc29yQ2FsbGJhY2soZXZ0KTtcblx0XHRcdFx0cmVzb2x2ZSgpO1xuXHRcdFx0fTtcblx0XHR9KTtcblx0fVxuXG5cdGNsZWFyKHN0b3JlTmFtZTogc3RyaW5nKSB7XG5cdFx0cmV0dXJuIG5ldyBQcm9taXNlPGFueT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdFx0dGhpcy5kYldyYXBwZXIudmFsaWRhdGVCZWZvcmVUcmFuc2FjdGlvbihzdG9yZU5hbWUsIHJlamVjdCk7XG5cdFx0XHRsZXQgdHJhbnNhY3Rpb24gPSB0aGlzLmRiV3JhcHBlci5jcmVhdGVUcmFuc2FjdGlvbihcblx0XHRcdFx0XHR0aGlzLmRiV3JhcHBlci5vcHRpb25zR2VuZXJhdG9yKERCTW9kZS5yZWFkd3JpdGUsIHN0b3JlTmFtZSwgcmVqZWN0LCByZXNvbHZlKVxuXHRcdFx0XHQpLFxuXHRcdFx0XHRvYmplY3RTdG9yZSA9IHRyYW5zYWN0aW9uLm9iamVjdFN0b3JlKHN0b3JlTmFtZSk7XG5cdFx0XHRvYmplY3RTdG9yZS5jbGVhcigpO1xuXHRcdFx0cmVzb2x2ZSgpO1xuXHRcdH0pO1xuXHR9XG5cblx0Z2V0QnlJbmRleChzdG9yZU5hbWU6IHN0cmluZywgaW5kZXhOYW1lOiBzdHJpbmcsIGtleTogYW55KSB7XG5cdFx0cmV0dXJuIG5ldyBQcm9taXNlPGFueT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdFx0dGhpcy5kYldyYXBwZXIudmFsaWRhdGVCZWZvcmVUcmFuc2FjdGlvbihzdG9yZU5hbWUsIHJlamVjdCk7XG5cdFx0XHRsZXQgdHJhbnNhY3Rpb24gPSB0aGlzLmRiV3JhcHBlci5jcmVhdGVUcmFuc2FjdGlvbihcblx0XHRcdFx0XHR0aGlzLmRiV3JhcHBlci5vcHRpb25zR2VuZXJhdG9yKERCTW9kZS5yZWFkb25seSwgc3RvcmVOYW1lLCByZWplY3QsIHJlc29sdmUpXG5cdFx0XHRcdCksXG5cdFx0XHRcdG9iamVjdFN0b3JlID0gdHJhbnNhY3Rpb24ub2JqZWN0U3RvcmUoc3RvcmVOYW1lKSxcblx0XHRcdFx0aW5kZXggPSBvYmplY3RTdG9yZS5pbmRleChpbmRleE5hbWUpLFxuXHRcdFx0XHRyZXF1ZXN0ID0gaW5kZXguZ2V0KGtleSk7XG5cblx0XHRcdHJlcXVlc3Qub25zdWNjZXNzID0gZXZlbnQgPT4ge1xuXHRcdFx0XHRyZXNvbHZlKCg8SURCT3BlbkRCUmVxdWVzdD5ldmVudC50YXJnZXQpLnJlc3VsdCk7XG5cdFx0XHR9O1xuXHRcdH0pO1xuXHR9XG59XG5cbmV4cG9ydCBjbGFzcyBVdGlscyB7XG5cdGluZGV4ZWREQjogSURCRmFjdG9yeTtcblxuXHRjb25zdHJ1Y3RvcigpIHtcblx0XHR0aGlzLmluZGV4ZWREQiA9XG5cdFx0XHR3aW5kb3cuaW5kZXhlZERCIHx8XG5cdFx0XHQoPGFueT53aW5kb3cpLm1vekluZGV4ZWREQiB8fFxuXHRcdFx0KDxhbnk+d2luZG93KS53ZWJraXRJbmRleGVkREIgfHxcblx0XHRcdCg8YW55PndpbmRvdykubXNJbmRleGVkREI7XG5cdH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBJbmRleERldGFpbHMge1xuXHRpbmRleE5hbWU6IHN0cmluZztcblx0b3JkZXI6IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIERiV3JhcHBlciB7XG5cdGRiTmFtZTogc3RyaW5nO1xuXHRkYlZlcnNpb246IG51bWJlcjtcblx0ZGI6IElEQkRhdGFiYXNlO1xuXG5cdGNvbnN0cnVjdG9yKGRiTmFtZTogc3RyaW5nLCB2ZXJzaW9uOiBudW1iZXIpIHtcblx0XHR0aGlzLmRiTmFtZSA9IGRiTmFtZTtcblx0XHR0aGlzLmRiVmVyc2lvbiA9IHZlcnNpb24gfHwgMTtcblx0fVxuXG5cdHZhbGlkYXRlU3RvcmVOYW1lKHN0b3JlTmFtZTogc3RyaW5nKSB7XG5cdFx0cmV0dXJuIHRoaXMuZGIub2JqZWN0U3RvcmVOYW1lcy5jb250YWlucyhzdG9yZU5hbWUpO1xuXHR9XG5cblx0dmFsaWRhdGVCZWZvcmVUcmFuc2FjdGlvbihzdG9yZU5hbWU6IHN0cmluZywgcmVqZWN0OiBGdW5jdGlvbikge1xuXHRcdGlmICghdGhpcy5kYikge1xuXHRcdFx0cmVqZWN0KCdZb3UgbmVlZCB0byB1c2UgdGhlIG9wZW5EYXRhYmFzZSBmdW5jdGlvbiB0byBjcmVhdGUgYSBkYXRhYmFzZSBiZWZvcmUgeW91IHF1ZXJ5IGl0IScpO1xuXHRcdH1cblx0XHRpZiAoIXRoaXMudmFsaWRhdGVTdG9yZU5hbWUoc3RvcmVOYW1lKSkge1xuXHRcdFx0cmVqZWN0KCdvYmplY3RTdG9yZSBkb2VzIG5vdCBleGlzdHM6ICcgKyBzdG9yZU5hbWUpO1xuXHRcdH1cblx0fVxuXG5cdGNyZWF0ZVRyYW5zYWN0aW9uKG9wdGlvbnM6IE9wdGlvbnMpOiBJREJUcmFuc2FjdGlvbiB7XG5cdFx0bGV0IHRyYW5zOiBJREJUcmFuc2FjdGlvbiA9IHRoaXMuZGIudHJhbnNhY3Rpb24ob3B0aW9ucy5zdG9yZU5hbWUsIG9wdGlvbnMuZGJNb2RlKTtcblx0XHR0cmFucy5vbmVycm9yID0gb3B0aW9ucy5lcnJvcjtcblx0XHR0cmFucy5vbmNvbXBsZXRlID0gb3B0aW9ucy5jb21wbGV0ZTtcblx0XHR0cmFucy5vbmFib3J0ID0gb3B0aW9ucy5hYm9ydDtcblx0XHRyZXR1cm4gdHJhbnM7XG5cdH1cblxuXHRvcHRpb25zR2VuZXJhdG9yKHR5cGU6IGFueSwgc3RvcmVOYW1lOiBhbnksIHJlamVjdDogRnVuY3Rpb24sIHJlc29sdmU6IEZ1bmN0aW9uKTogT3B0aW9ucyB7XG5cdFx0cmV0dXJuIHtcblx0XHRcdHN0b3JlTmFtZTogc3RvcmVOYW1lLFxuXHRcdFx0ZGJNb2RlOiB0eXBlLFxuXHRcdFx0ZXJyb3I6IChlOiBFdmVudCkgPT4ge1xuXHRcdFx0XHRyZWplY3QoZSk7XG5cdFx0XHR9LFxuXHRcdFx0Y29tcGxldGU6IChlOiBFdmVudCkgPT4ge1xuXHRcdFx0XHRyZXNvbHZlKCk7XG5cdFx0XHR9LFxuXHRcdFx0YWJvcnQ6IChlOiBFdmVudCkgPT4ge1xuXHRcdFx0XHRyZWplY3QoZSk7XG5cdFx0XHR9XG5cdFx0fTtcblx0fVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIE9wdGlvbnMge1xuXHRzdG9yZU5hbWU6IHN0cmluZztcblx0ZGJNb2RlOiBJREJUcmFuc2FjdGlvbk1vZGU7XG5cdGVycm9yOiAoZTogRXZlbnQpID0+IGFueTtcblx0Y29tcGxldGU6IChlOiBFdmVudCkgPT4gYW55O1xuXHRhYm9ydD86IGFueTtcbn1cblxuZXhwb3J0IGVudW0gREJNb2RlIHtcblx0cmVhZG9ubHkgPSAncmVhZG9ubHknLFxuXHRyZWFkd3JpdGUgPSAncmVhZHdyaXRlJ1xufVxuIl19