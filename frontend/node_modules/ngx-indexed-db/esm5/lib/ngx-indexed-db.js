/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
var NgxIndexedDB = /** @class */ (function () {
    function NgxIndexedDB(dbName, version) {
        this.utils = new Utils();
        this.dbWrapper = new DbWrapper(dbName, version);
    }
    /**
     * @param {?} version
     * @param {?=} upgradeCallback
     * @return {?}
     */
    NgxIndexedDB.prototype.openDatabase = /**
     * @param {?} version
     * @param {?=} upgradeCallback
     * @return {?}
     */
    function (version, upgradeCallback) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.dbWrapper.dbVersion = version;
            /** @type {?} */
            var request = _this.utils.indexedDB.open(_this.dbWrapper.dbName, version);
            request.onsuccess = function (e) {
                _this.dbWrapper.db = request.result;
                resolve();
            };
            request.onerror = function (e) {
                reject('IndexedDB error: ' + (/** @type {?} */ (e.target)).errorCode
                    ? (/** @type {?} */ (e.target)).errorCode + ' (' + (/** @type {?} */ (e.target)).error + ')'
                    : (/** @type {?} */ (e.target)).errorCode);
            };
            if (typeof upgradeCallback === 'function') {
                request.onupgradeneeded = function (e) {
                    upgradeCallback(e, _this.dbWrapper.db);
                };
            }
        });
    };
    /**
     * @param {?} storeName
     * @param {?} key
     * @return {?}
     */
    NgxIndexedDB.prototype.getByKey = /**
     * @param {?} storeName
     * @param {?} key
     * @return {?}
     */
    function (storeName, key) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.dbWrapper.validateBeforeTransaction(storeName, reject);
            /** @type {?} */
            var transaction = _this.dbWrapper.createTransaction(_this.dbWrapper.optionsGenerator(DBMode.readonly, storeName, reject, resolve));
            /** @type {?} */
            var objectStore = transaction.objectStore(storeName);
            /** @type {?} */
            var request;
            request = objectStore.get(key);
            request.onsuccess = function (event) {
                resolve((/** @type {?} */ (event.target)).result);
            };
        });
    };
    /**
     * @param {?} storeName
     * @param {?=} keyRange
     * @param {?=} indexDetails
     * @return {?}
     */
    NgxIndexedDB.prototype.getAll = /**
     * @param {?} storeName
     * @param {?=} keyRange
     * @param {?=} indexDetails
     * @return {?}
     */
    function (storeName, keyRange, indexDetails) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.dbWrapper.validateBeforeTransaction(storeName, reject);
            /** @type {?} */
            var transaction = _this.dbWrapper.createTransaction(_this.dbWrapper.optionsGenerator(DBMode.readonly, storeName, reject, resolve));
            /** @type {?} */
            var objectStore = transaction.objectStore(storeName);
            /** @type {?} */
            var result = [];
            /** @type {?} */
            var request;
            if (indexDetails) {
                /** @type {?} */
                var index = objectStore.index(indexDetails.indexName);
                /** @type {?} */
                var order = indexDetails.order === 'desc' ? 'prev' : 'next';
                request = index.openCursor(keyRange, /** @type {?} */ (order));
            }
            else {
                request = objectStore.openCursor(keyRange);
            }
            request.onerror = function (e) {
                reject(e);
            };
            request.onsuccess = function (evt) {
                /** @type {?} */
                var cursor = (/** @type {?} */ (evt.target)).result;
                if (cursor) {
                    result.push(cursor['value']);
                    cursor['continue']();
                }
                else {
                    resolve(result);
                }
            };
        });
    };
    /**
     * @param {?} storeName
     * @param {?} value
     * @param {?=} key
     * @return {?}
     */
    NgxIndexedDB.prototype.add = /**
     * @param {?} storeName
     * @param {?} value
     * @param {?=} key
     * @return {?}
     */
    function (storeName, value, key) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.dbWrapper.validateBeforeTransaction(storeName, reject);
            /** @type {?} */
            var transaction = _this.dbWrapper.createTransaction(_this.dbWrapper.optionsGenerator(DBMode.readwrite, storeName, reject, resolve));
            /** @type {?} */
            var objectStore = transaction.objectStore(storeName);
            /** @type {?} */
            var request = objectStore.add(value, key);
            request.onsuccess = function (evt) {
                key = evt.target.result;
            };
        });
    };
    /**
     * @param {?} storeName
     * @param {?} value
     * @param {?=} key
     * @return {?}
     */
    NgxIndexedDB.prototype.update = /**
     * @param {?} storeName
     * @param {?} value
     * @param {?=} key
     * @return {?}
     */
    function (storeName, value, key) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.dbWrapper.validateBeforeTransaction(storeName, reject);
            /** @type {?} */
            var transaction = _this.dbWrapper.createTransaction(_this.dbWrapper.optionsGenerator(DBMode.readwrite, storeName, reject, resolve));
            /** @type {?} */
            var objectStore = transaction.objectStore(storeName);
            objectStore.put(value, key);
        });
    };
    /**
     * @param {?} storeName
     * @param {?} key
     * @return {?}
     */
    NgxIndexedDB.prototype.delete = /**
     * @param {?} storeName
     * @param {?} key
     * @return {?}
     */
    function (storeName, key) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.dbWrapper.validateBeforeTransaction(storeName, reject);
            /** @type {?} */
            var transaction = _this.dbWrapper.createTransaction(_this.dbWrapper.optionsGenerator(DBMode.readwrite, storeName, reject, resolve));
            /** @type {?} */
            var objectStore = transaction.objectStore(storeName);
            objectStore['delete'](key);
        });
    };
    /**
     * @param {?} storeName
     * @param {?} cursorCallback
     * @param {?=} keyRange
     * @return {?}
     */
    NgxIndexedDB.prototype.openCursor = /**
     * @param {?} storeName
     * @param {?} cursorCallback
     * @param {?=} keyRange
     * @return {?}
     */
    function (storeName, cursorCallback, keyRange) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.dbWrapper.validateBeforeTransaction(storeName, reject);
            /** @type {?} */
            var transaction = _this.dbWrapper.createTransaction(_this.dbWrapper.optionsGenerator(DBMode.readonly, storeName, reject, resolve));
            /** @type {?} */
            var objectStore = transaction.objectStore(storeName);
            /** @type {?} */
            var request = objectStore.openCursor(keyRange);
            request.onsuccess = function (evt) {
                cursorCallback(evt);
                resolve();
            };
        });
    };
    /**
     * @param {?} storeName
     * @return {?}
     */
    NgxIndexedDB.prototype.clear = /**
     * @param {?} storeName
     * @return {?}
     */
    function (storeName) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.dbWrapper.validateBeforeTransaction(storeName, reject);
            /** @type {?} */
            var transaction = _this.dbWrapper.createTransaction(_this.dbWrapper.optionsGenerator(DBMode.readwrite, storeName, reject, resolve));
            /** @type {?} */
            var objectStore = transaction.objectStore(storeName);
            objectStore.clear();
            resolve();
        });
    };
    /**
     * @param {?} storeName
     * @param {?} indexName
     * @param {?} key
     * @return {?}
     */
    NgxIndexedDB.prototype.getByIndex = /**
     * @param {?} storeName
     * @param {?} indexName
     * @param {?} key
     * @return {?}
     */
    function (storeName, indexName, key) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.dbWrapper.validateBeforeTransaction(storeName, reject);
            /** @type {?} */
            var transaction = _this.dbWrapper.createTransaction(_this.dbWrapper.optionsGenerator(DBMode.readonly, storeName, reject, resolve));
            /** @type {?} */
            var objectStore = transaction.objectStore(storeName);
            /** @type {?} */
            var index = objectStore.index(indexName);
            /** @type {?} */
            var request = index.get(key);
            request.onsuccess = function (event) {
                resolve((/** @type {?} */ (event.target)).result);
            };
        });
    };
    return NgxIndexedDB;
}());
export { NgxIndexedDB };
if (false) {
    /** @type {?} */
    NgxIndexedDB.prototype.utils;
    /** @type {?} */
    NgxIndexedDB.prototype.dbWrapper;
}
var Utils = /** @class */ (function () {
    function Utils() {
        this.indexedDB =
            window.indexedDB ||
                (/** @type {?} */ (window)).mozIndexedDB ||
                (/** @type {?} */ (window)).webkitIndexedDB ||
                (/** @type {?} */ (window)).msIndexedDB;
    }
    return Utils;
}());
export { Utils };
if (false) {
    /** @type {?} */
    Utils.prototype.indexedDB;
}
/**
 * @record
 */
export function IndexDetails() { }
/** @type {?} */
IndexDetails.prototype.indexName;
/** @type {?} */
IndexDetails.prototype.order;
var DbWrapper = /** @class */ (function () {
    function DbWrapper(dbName, version) {
        this.dbName = dbName;
        this.dbVersion = version || 1;
    }
    /**
     * @param {?} storeName
     * @return {?}
     */
    DbWrapper.prototype.validateStoreName = /**
     * @param {?} storeName
     * @return {?}
     */
    function (storeName) {
        return this.db.objectStoreNames.contains(storeName);
    };
    /**
     * @param {?} storeName
     * @param {?} reject
     * @return {?}
     */
    DbWrapper.prototype.validateBeforeTransaction = /**
     * @param {?} storeName
     * @param {?} reject
     * @return {?}
     */
    function (storeName, reject) {
        if (!this.db) {
            reject('You need to use the openDatabase function to create a database before you query it!');
        }
        if (!this.validateStoreName(storeName)) {
            reject('objectStore does not exists: ' + storeName);
        }
    };
    /**
     * @param {?} options
     * @return {?}
     */
    DbWrapper.prototype.createTransaction = /**
     * @param {?} options
     * @return {?}
     */
    function (options) {
        /** @type {?} */
        var trans = this.db.transaction(options.storeName, options.dbMode);
        trans.onerror = options.error;
        trans.oncomplete = options.complete;
        trans.onabort = options.abort;
        return trans;
    };
    /**
     * @param {?} type
     * @param {?} storeName
     * @param {?} reject
     * @param {?} resolve
     * @return {?}
     */
    DbWrapper.prototype.optionsGenerator = /**
     * @param {?} type
     * @param {?} storeName
     * @param {?} reject
     * @param {?} resolve
     * @return {?}
     */
    function (type, storeName, reject, resolve) {
        return {
            storeName: storeName,
            dbMode: type,
            error: function (e) {
                reject(e);
            },
            complete: function (e) {
                resolve();
            },
            abort: function (e) {
                reject(e);
            }
        };
    };
    return DbWrapper;
}());
export { DbWrapper };
if (false) {
    /** @type {?} */
    DbWrapper.prototype.dbName;
    /** @type {?} */
    DbWrapper.prototype.dbVersion;
    /** @type {?} */
    DbWrapper.prototype.db;
}
/**
 * @record
 */
export function Options() { }
/** @type {?} */
Options.prototype.storeName;
/** @type {?} */
Options.prototype.dbMode;
/** @type {?} */
Options.prototype.error;
/** @type {?} */
Options.prototype.complete;
/** @type {?|undefined} */
Options.prototype.abort;
/** @enum {string} */
var DBMode = {
    readonly: 'readonly',
    readwrite: 'readwrite',
};
export { DBMode };

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LWluZGV4ZWQtZGIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtaW5kZXhlZC1kYi8iLCJzb3VyY2VzIjpbImxpYi9uZ3gtaW5kZXhlZC1kYi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsSUFBQTtJQUlDLHNCQUFZLE1BQWMsRUFBRSxPQUFlO1FBQzFDLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxLQUFLLEVBQUUsQ0FBQztRQUN6QixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksU0FBUyxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztLQUNoRDs7Ozs7O0lBRUQsbUNBQVk7Ozs7O0lBQVosVUFBYSxPQUFlLEVBQUUsZUFBMEI7UUFBeEQsaUJBdUJDO1FBdEJBLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBTSxVQUFDLE9BQU8sRUFBRSxNQUFNO1lBQ3ZDLEtBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxHQUFHLE9BQU8sQ0FBQzs7WUFDbkMsSUFBSSxPQUFPLEdBQUcsS0FBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQ3hFLE9BQU8sQ0FBQyxTQUFTLEdBQUcsVUFBQSxDQUFDO2dCQUNwQixLQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDO2dCQUNuQyxPQUFPLEVBQUUsQ0FBQzthQUNWLENBQUM7WUFFRixPQUFPLENBQUMsT0FBTyxHQUFHLFVBQUEsQ0FBQztnQkFDbEIsTUFBTSxDQUNMLG1CQUFtQixHQUFHLG1CQUFNLENBQUMsQ0FBQyxNQUFNLEVBQUMsQ0FBQyxTQUFTO29CQUM5QyxDQUFDLENBQUMsbUJBQU0sQ0FBQyxDQUFDLE1BQU0sRUFBQyxDQUFDLFNBQVMsR0FBRyxJQUFJLEdBQUcsbUJBQU0sQ0FBQyxDQUFDLE1BQU0sRUFBQyxDQUFDLEtBQUssR0FBRyxHQUFHO29CQUNo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QUFNLENBQUM7WUFDTixTQUFTLEVBQUUsU0FBUztZQUNwQixNQUFNLEVBQUUsSUFBSTtZQUNaLEtBQUssRUFBRSxVQUFDLENBQVE7Z0JBQ2YsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ1Y7WUFDRCxRQUFRLEVBQUUsVUFBQyxDQUFRO2dCQUNsQixPQUFPLEVBQUUsQ0FBQzthQUNWO1lBQ0QsS0FBSyxFQUFFLFVBQUMsQ0FBUTtnQkFDZixNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDVjtTQUNELENBQUM7S0FDRjtvQkF6T0Y7SUEwT0MsQ0FBQTtBQTlDRCxxQkE4Q0M7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7SUFXQSxVQUFXLFVBQVU7SUFDckIsV0FBWSxXQUFXIiwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IGNsYXNzIE5neEluZGV4ZWREQiB7XG5cdHV0aWxzOiBVdGlscztcblx0ZGJXcmFwcGVyOiBEYldyYXBwZXI7XG5cblx0Y29uc3RydWN0b3IoZGJOYW1lOiBzdHJpbmcsIHZlcnNpb246IG51bWJlcikge1xuXHRcdHRoaXMudXRpbHMgPSBuZXcgVXRpbHMoKTtcblx0XHR0aGlzLmRiV3JhcHBlciA9IG5ldyBEYldyYXBwZXIoZGJOYW1lLCB2ZXJzaW9uKTtcblx0fVxuXG5cdG9wZW5EYXRhYmFzZSh2ZXJzaW9uOiBudW1iZXIsIHVwZ3JhZGVDYWxsYmFjaz86IEZ1bmN0aW9uKSB7XG5cdFx0cmV0dXJuIG5ldyBQcm9taXNlPGFueT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdFx0dGhpcy5kYldyYXBwZXIuZGJWZXJzaW9uID0gdmVyc2lvbjtcblx0XHRcdGxldCByZXF1ZXN0ID0gdGhpcy51dGlscy5pbmRleGVkREIub3Blbih0aGlzLmRiV3JhcHBlci5kYk5hbWUsIHZlcnNpb24pO1xuXHRcdFx0cmVxdWVzdC5vbnN1Y2Nlc3MgPSBlID0+IHtcblx0XHRcdFx0dGhpcy5kYldyYXBwZXIuZGIgPSByZXF1ZXN0LnJlc3VsdDtcblx0XHRcdFx0cmVzb2x2ZSgpO1xuXHRcdFx0fTtcblxuXHRcdFx0cmVxdWVzdC5vbmVycm9yID0gZSA9PiB7XG5cdFx0XHRcdHJlamVjdChcblx0XHRcdFx0XHQnSW5kZXhlZERCIGVycm9yOiAnICsgKDxhbnk+ZS50YXJnZXQpLmVycm9yQ29kZVxuXHRcdFx0XHRcdFx0PyAoPGFueT5lLnRhcmdldCkuZXJyb3JDb2RlICsgJyAoJyArICg8YW55PmUudGFyZ2V0KS5lcnJvciArICcpJ1xuXHRcdFx0XHRcdFx0OiAoPGFueT5lLnRhcmdldCkuZXJyb3JDb2RlXG5cdFx0XHRcdCk7XG5cdFx0XHR9O1xuXG5cdFx0XHRpZiAodHlwZW9mIHVwZ3JhZGVDYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykge1xuXHRcdFx0XHRyZXF1ZXN0Lm9udXBncmFkZW5lZWRlZCA9IGUgPT4ge1xuXHRcdFx0XHRcdHVwZ3JhZGVDYWxsYmFjayhlLCB0aGlzLmRiV3JhcHBlci5kYik7XG5cdFx0XHRcdH07XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH1cblxuXHRnZXRCeUtleShzdG9yZU5hbWU6IHN0cmluZywga2V5OiBhbnkpIHtcblx0XHRyZXR1cm4gbmV3IFByb21pc2U8YW55PigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cdFx0XHR0aGlzLmRiV3JhcHBlci52YWxpZGF0ZUJlZm9yZVRyYW5zYWN0aW9uKHN0b3JlTmFtZSwgcmVqZWN0KTtcblxuXHRcdFx0bGV0IHRyYW5zYWN0aW9uID0gdGhpcy5kYldyYXBwZXIuY3JlYXRlVHJhbnNhY3Rpb24oXG5cdFx0XHRcdFx0dGhpcy5kYldyYXBwZXIub3B0aW9uc0dlbmVyYXRvcihEQk1vZGUucmVhZG9ubHksIHN0b3JlTmFtZSwgcmVqZWN0LCByZXNvbHZlKVxuXHRcdFx0XHQpLFxuXHRcdFx0XHRvYmplY3RTdG9yZSA9IHRyYW5zYWN0aW9uLm9iamVjdFN0b3JlKHN0b3JlTmFtZSksXG5cdFx0XHRcdHJlcXVlc3Q6IElEQlJlcXVlc3Q7XG5cblx0XHRcdHJlcXVlc3QgPSBvYmplY3RTdG9yZS5nZXQoa2V5KTtcblx0XHRcdHJlcXVlc3Qub25zdWNjZXNzID0gZnVuY3Rpb24oZXZlbnQ6IEV2ZW50KSB7XG5cdFx0XHRcdHJlc29sdmUoKDxhbnk+ZXZlbnQudGFyZ2V0KS5yZXN1bHQpO1xuXHRcdFx0fTtcblx0XHR9KTtcblx0fVxuXG5cdGdldEFsbChzdG9yZU5hbWU6IHN0cmluZywga2V5UmFuZ2U/OiBJREJLZXlSYW5nZSwgaW5kZXhEZXRhaWxzPzogSW5kZXhEZXRhaWxzKSB7XG5cdFx0cmV0dXJuIG5ldyBQcm9taXNlPGFueT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdFx0dGhpcy5kYldyYXBwZXIudmFsaWRhdGVCZWZvcmVUcmFuc2FjdGlvbihzdG9yZU5hbWUsIHJlamVjdCk7XG5cblx0XHRcdGxldCB0cmFuc2FjdGlvbiA9IHRoaXMuZGJXcmFwcGVyLmNyZWF0ZVRyYW5zYWN0aW9uKFxuXHRcdFx0XHRcdHRoaXMuZGJXcmFwcGVyLm9wdGlvbnNHZW5lcmF0b3IoREJNb2RlLnJlYWRvbmx5LCBzdG9yZU5hbWUsIHJlamVjdCwgcmVzb2x2ZSlcblx0XHRcdFx0KSxcblx0XHRcdFx0b2JqZWN0U3RvcmUgPSB0cmFuc2FjdGlvbi5vYmplY3RTdG9yZShzdG9yZU5hbWUpLFxuXHRcdFx0XHRyZXN1bHQ6IEFycmF5PGFueT4gPSBbXSxcblx0XHRcdFx0cmVxdWVzdDogSURCUmVxdWVzdDtcblx0XHRcdGlmIChpbmRleERldGFpbHMpIHtcblx0XHRcdFx0bGV0IGluZGV4ID0gb2JqZWN0U3RvcmUuaW5kZXgoaW5kZXhEZXRhaWxzLmluZGV4TmFtZSksXG5cdFx0XHRcdFx0b3JkZXIgPSBpbmRleERldGFpbHMub3JkZXIgPT09ICdkZXNjJyA/ICdwcmV2JyA6ICduZXh0Jztcblx0XHRcdFx0cmVxdWVzdCA9IGluZGV4Lm9wZW5DdXJzb3Ioa2V5UmFuZ2UsIDxJREJDdXJzb3JEaXJlY3Rpb24+b3JkZXIpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0cmVxdWVzdCA9IG9iamVjdFN0b3JlLm9wZW5DdXJzb3Ioa2V5UmFuZ2UpO1xuXHRcdFx0fVxuXG5cdFx0XHRyZXF1ZXN0Lm9uZXJyb3IgPSBmdW5jdGlvbihlKSB7XG5cdFx0XHRcdHJlamVjdChlKTtcblx0XHRcdH07XG5cblx0XHRcdHJlcXVlc3Qub25zdWNjZXNzID0gZnVuY3Rpb24oZXZ0OiBFdmVudCkge1xuXHRcdFx0XHRsZXQgY3Vyc29yID0gKDxJREJPcGVuREJSZXF1ZXN0PmV2dC50YXJnZXQpLnJlc3VsdDtcblx0XHRcdFx0aWYgKGN1cnNvcikge1xuXHRcdFx0XHRcdHJlc3VsdC5wdXNoKGN1cnNvclsndmFsdWUnXSk7XG5cdFx0XHRcdFx0Y3Vyc29yWydjb250aW51ZSddKCk7XG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0cmVzb2x2ZShyZXN1bHQpO1xuXHRcdFx0XHR9XG5cdFx0XHR9O1xuXHRcdH0pO1xuXHR9XG5cblx0YWRkKHN0b3JlTmFtZTogc3RyaW5nLCB2YWx1ZTogYW55LCBrZXk/OiBhbnkpIHtcblx0XHRyZXR1cm4gbmV3IFByb21pc2U8YW55PigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cdFx0XHR0aGlzLmRiV3JhcHBlci52YWxpZGF0ZUJlZm9yZVRyYW5zYWN0aW9uKHN0b3JlTmFtZSwgcmVqZWN0KTtcblx0XHRcdGxldCB0cmFuc2FjdGlvbiA9IHRoaXMuZGJXcmFwcGVyLmNyZWF0ZVRyYW5zYWN0aW9uKFxuXHRcdFx0XHRcdHRoaXMuZGJXcmFwcGVyLm9wdGlvbnNHZW5lcmF0b3IoREJNb2RlLnJlYWR3cml0ZSwgc3RvcmVOYW1lLCByZWplY3QsIHJlc29sdmUpXG5cdFx0XHRcdCksXG5cdFx0XHRcdG9iamVjdFN0b3JlID0gdHJhbnNhY3Rpb24ub2JqZWN0U3RvcmUoc3RvcmVOYW1lKTtcblxuXHRcdFx0bGV0IHJlcXVlc3QgPSBvYmplY3RTdG9yZS5hZGQodmFsdWUsIGtleSk7XG5cdFx0XHRyZXF1ZXN0Lm9uc3VjY2VzcyA9IChldnQ6IGFueSkgPT4ge1xuXHRcdFx0XHRrZXkgPSBldnQudGFyZ2V0LnJlc3VsdDtcblx0XHRcdH07XG5cdFx0fSk7XG5cdH1cblxuXHR1cGRhdGUoc3RvcmVOYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnksIGtleT86IGFueSkge1xuXHRcdHJldHVybiBuZXcgUHJvbWlzZTxhbnk+KChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHRcdHRoaXMuZGJXcmFwcGVyLnZhbGlkYXRlQmVmb3JlVHJhbnNhY3Rpb24oc3RvcmVOYW1lLCByZWplY3QpO1xuXG5cdFx0XHRsZXQgdHJhbnNhY3Rpb24gPSB0aGlzLmRiV3JhcHBlci5jcmVhdGVUcmFuc2FjdGlvbihcblx0XHRcdFx0XHR0aGlzLmRiV3JhcHBlci5vcHRpb25zR2VuZXJhdG9yKERCTW9kZS5yZWFkd3JpdGUsIHN0b3JlTmFtZSwgcmVqZWN0LCByZXNvbHZlKVxuXHRcdFx0XHQpLFxuXHRcdFx0XHRvYmplY3RTdG9yZSA9IHRyYW5zYWN0aW9uLm9iamVjdFN0b3JlKHN0b3JlTmFtZSk7XG5cblx0XHRcdG9iamVjdFN0b3JlLnB1dCh2YWx1ZSwga2V5KTtcblx0XHR9KTtcblx0fVxuXG5cdGRlbGV0ZShzdG9yZU5hbWU6IHN0cmluZywga2V5OiBhbnkpIHtcblx0XHRyZXR1cm4gbmV3IFByb21pc2U8YW55PigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cdFx0XHR0aGlzLmRiV3JhcHBlci52YWxpZGF0ZUJlZm9yZVRyYW5zYWN0aW9uKHN0b3JlTmFtZSwgcmVqZWN0KTtcblxuXHRcdFx0bGV0IHRyYW5zYWN0aW9uID0gdGhpcy5kYldyYXBwZXIuY3JlYXRlVHJhbnNhY3Rpb24oXG5cdFx0XHRcdFx0dGhpcy5kYldyYXBwZXIub3B0aW9uc0dlbmVyYXRvcihEQk1vZGUucmVhZHdyaXRlLCBzdG9yZU5hbWUsIHJlamVjdCwgcmVzb2x2ZSlcblx0XHRcdFx0KSxcblx0XHRcdFx0b2JqZWN0U3RvcmUgPSB0cmFuc2FjdGlvbi5vYmplY3RTdG9yZShzdG9yZU5hbWUpO1xuXG5cdFx0XHRvYmplY3RTdG9yZVsnZGVsZXRlJ10oa2V5KTtcblx0XHR9KTtcblx0fVxuXG5cdG9wZW5DdXJzb3Ioc3RvcmVOYW1lOiBzdHJpbmcsIGN1cnNvckNhbGxiYWNrOiAoZXZ0OiBFdmVudCkgPT4gdm9pZCwga2V5UmFuZ2U/OiBJREJLZXlSYW5nZSkge1xuXHRcdHJldHVybiBuZXcgUHJvbWlzZTxhbnk+KChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHRcdHRoaXMuZGJXcmFwcGVyLnZhbGlkYXRlQmVmb3JlVHJhbnNhY3Rpb24oc3RvcmVOYW1lLCByZWplY3QpO1xuXHRcdFx0bGV0IHRyYW5zYWN0aW9uID0gdGhpcy5kYldyYXBwZXIuY3JlYXRlVHJhbnNhY3Rpb24oXG5cdFx0XHRcdFx0dGhpcy5kYldyYXBwZXIub3B0aW9uc0dlbmVyYXRvcihEQk1vZGUucmVhZG9ubHksIHN0b3JlTmFtZSwgcmVqZWN0LCByZXNvbHZlKVxuXHRcdFx0XHQpLFxuXHRcdFx0XHRvYmplY3RTdG9yZSA9IHRyYW5zYWN0aW9uLm9iamVjdFN0b3JlKHN0b3JlTmFtZSksXG5cdFx0XHRcdHJlcXVlc3QgPSBvYmplY3RTdG9yZS5vcGVuQ3Vyc29yKGtleVJhbmdlKTtcblxuXHRcdFx0cmVxdWVzdC5vbnN1Y2Nlc3MgPSAoZXZ0OiBFdmVudCkgPT4ge1xuXHRcdFx0XHRjdXJzb3JDYWxsYmFjayhldnQpO1xuXHRcdFx0XHRyZXNvbHZlKCk7XG5cdFx0XHR9O1xuXHRcdH0pO1xuXHR9XG5cblx0Y2xlYXIoc3RvcmVOYW1lOiBzdHJpbmcpIHtcblx0XHRyZXR1cm4gbmV3IFByb21pc2U8YW55PigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cdFx0XHR0aGlzLmRiV3JhcHBlci52YWxpZGF0ZUJlZm9yZVRyYW5zYWN0aW9uKHN0b3JlTmFtZSwgcmVqZWN0KTtcblx0XHRcdGxldCB0cmFuc2FjdGlvbiA9IHRoaXMuZGJXcmFwcGVyLmNyZWF0ZVRyYW5zYWN0aW9uKFxuXHRcdFx0XHRcdHRoaXMuZGJXcmFwcGVyLm9wdGlvbnNHZW5lcmF0b3IoREJNb2RlLnJlYWR3cml0ZSwgc3RvcmVOYW1lLCByZWplY3QsIHJlc29sdmUpXG5cdFx0XHRcdCksXG5cdFx0XHRcdG9iamVjdFN0b3JlID0gdHJhbnNhY3Rpb24ub2JqZWN0U3RvcmUoc3RvcmVOYW1lKTtcblx0XHRcdG9iamVjdFN0b3JlLmNsZWFyKCk7XG5cdFx0XHRyZXNvbHZlKCk7XG5cdFx0fSk7XG5cdH1cblxuXHRnZXRCeUluZGV4KHN0b3JlTmFtZTogc3RyaW5nLCBpbmRleE5hbWU6IHN0cmluZywga2V5OiBhbnkpIHtcblx0XHRyZXR1cm4gbmV3IFByb21pc2U8YW55PigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cdFx0XHR0aGlzLmRiV3JhcHBlci52YWxpZGF0ZUJlZm9yZVRyYW5zYWN0aW9uKHN0b3JlTmFtZSwgcmVqZWN0KTtcblx0XHRcdGxldCB0cmFuc2FjdGlvbiA9IHRoaXMuZGJXcmFwcGVyLmNyZWF0ZVRyYW5zYWN0aW9uKFxuXHRcdFx0XHRcdHRoaXMuZGJXcmFwcGVyLm9wdGlvbnNHZW5lcmF0b3IoREJNb2RlLnJlYWRvbmx5LCBzdG9yZU5hbWUsIHJlamVjdCwgcmVzb2x2ZSlcblx0XHRcdFx0KSxcblx0XHRcdFx0b2JqZWN0U3RvcmUgPSB0cmFuc2FjdGlvbi5vYmplY3RTdG9yZShzdG9yZU5hbWUpLFxuXHRcdFx0XHRpbmRleCA9IG9iamVjdFN0b3JlLmluZGV4KGluZGV4TmFtZSksXG5cdFx0XHRcdHJlcXVlc3QgPSBpbmRleC5nZXQoa2V5KTtcblxuXHRcdFx0cmVxdWVzdC5vbnN1Y2Nlc3MgPSBldmVudCA9PiB7XG5cdFx0XHRcdHJlc29sdmUoKDxJREJPcGVuREJSZXF1ZXN0PmV2ZW50LnRhcmdldCkucmVzdWx0KTtcblx0XHRcdH07XG5cdFx0fSk7XG5cdH1cbn1cblxuZXhwb3J0IGNsYXNzIFV0aWxzIHtcblx0aW5kZXhlZERCOiBJREJGYWN0b3J5O1xuXG5cdGNvbnN0cnVjdG9yKCkge1xuXHRcdHRoaXMuaW5kZXhlZERCID1cblx0XHRcdHdpbmRvdy5pbmRleGVkREIgfHxcblx0XHRcdCg8YW55PndpbmRvdykubW96SW5kZXhlZERCIHx8XG5cdFx0XHQoPGFueT53aW5kb3cpLndlYmtpdEluZGV4ZWREQiB8fFxuXHRcdFx0KDxhbnk+d2luZG93KS5tc0luZGV4ZWREQjtcblx0fVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIEluZGV4RGV0YWlscyB7XG5cdGluZGV4TmFtZTogc3RyaW5nO1xuXHRvcmRlcjogc3RyaW5nO1xufVxuXG5leHBvcnQgY2xhc3MgRGJXcmFwcGVyIHtcblx0ZGJOYW1lOiBzdHJpbmc7XG5cdGRiVmVyc2lvbjogbnVtYmVyO1xuXHRkYjogSURCRGF0YWJhc2U7XG5cblx0Y29uc3RydWN0b3IoZGJOYW1lOiBzdHJpbmcsIHZlcnNpb246IG51bWJlcikge1xuXHRcdHRoaXMuZGJOYW1lID0gZGJOYW1lO1xuXHRcdHRoaXMuZGJWZXJzaW9uID0gdmVyc2lvbiB8fCAxO1xuXHR9XG5cblx0dmFsaWRhdGVTdG9yZU5hbWUoc3RvcmVOYW1lOiBzdHJpbmcpIHtcblx0XHRyZXR1cm4gdGhpcy5kYi5vYmplY3RTdG9yZU5hbWVzLmNvbnRhaW5zKHN0b3JlTmFtZSk7XG5cdH1cblxuXHR2YWxpZGF0ZUJlZm9yZVRyYW5zYWN0aW9uKHN0b3JlTmFtZTogc3RyaW5nLCByZWplY3Q6IEZ1bmN0aW9uKSB7XG5cdFx0aWYgKCF0aGlzLmRiKSB7XG5cdFx0XHRyZWplY3QoJ1lvdSBuZWVkIHRvIHVzZSB0aGUgb3BlbkRhdGFiYXNlIGZ1bmN0aW9uIHRvIGNyZWF0ZSBhIGRhdGFiYXNlIGJlZm9yZSB5b3UgcXVlcnkgaXQhJyk7XG5cdFx0fVxuXHRcdGlmICghdGhpcy52YWxpZGF0ZVN0b3JlTmFtZShzdG9yZU5hbWUpKSB7XG5cdFx0XHRyZWplY3QoJ29iamVjdFN0b3JlIGRvZXMgbm90IGV4aXN0czogJyArIHN0b3JlTmFtZSk7XG5cdFx0fVxuXHR9XG5cblx0Y3JlYXRlVHJhbnNhY3Rpb24ob3B0aW9uczogT3B0aW9ucyk6IElEQlRyYW5zYWN0aW9uIHtcblx0XHRsZXQgdHJhbnM6IElEQlRyYW5zYWN0aW9uID0gdGhpcy5kYi50cmFuc2FjdGlvbihvcHRpb25zLnN0b3JlTmFtZSwgb3B0aW9ucy5kYk1vZGUpO1xuXHRcdHRyYW5zLm9uZXJyb3IgPSBvcHRpb25zLmVycm9yO1xuXHRcdHRyYW5zLm9uY29tcGxldGUgPSBvcHRpb25zLmNvbXBsZXRlO1xuXHRcdHRyYW5zLm9uYWJvcnQgPSBvcHRpb25zLmFib3J0O1xuXHRcdHJldHVybiB0cmFucztcblx0fVxuXG5cdG9wdGlvbnNHZW5lcmF0b3IodHlwZTogYW55LCBzdG9yZU5hbWU6IGFueSwgcmVqZWN0OiBGdW5jdGlvbiwgcmVzb2x2ZTogRnVuY3Rpb24pOiBPcHRpb25zIHtcblx0XHRyZXR1cm4ge1xuXHRcdFx0c3RvcmVOYW1lOiBzdG9yZU5hbWUsXG5cdFx0XHRkYk1vZGU6IHR5cGUsXG5cdFx0XHRlcnJvcjogKGU6IEV2ZW50KSA9PiB7XG5cdFx0XHRcdHJlamVjdChlKTtcblx0XHRcdH0sXG5cdFx0XHRjb21wbGV0ZTogKGU6IEV2ZW50KSA9PiB7XG5cdFx0XHRcdHJlc29sdmUoKTtcblx0XHRcdH0sXG5cdFx0XHRhYm9ydDogKGU6IEV2ZW50KSA9PiB7XG5cdFx0XHRcdHJlamVjdChlKTtcblx0XHRcdH1cblx0XHR9O1xuXHR9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgT3B0aW9ucyB7XG5cdHN0b3JlTmFtZTogc3RyaW5nO1xuXHRkYk1vZGU6IElEQlRyYW5zYWN0aW9uTW9kZTtcblx0ZXJyb3I6IChlOiBFdmVudCkgPT4gYW55O1xuXHRjb21wbGV0ZTogKGU6IEV2ZW50KSA9PiBhbnk7XG5cdGFib3J0PzogYW55O1xufVxuXG5leHBvcnQgZW51bSBEQk1vZGUge1xuXHRyZWFkb25seSA9ICdyZWFkb25seScsXG5cdHJlYWR3cml0ZSA9ICdyZWFkd3JpdGUnXG59XG4iXX0=