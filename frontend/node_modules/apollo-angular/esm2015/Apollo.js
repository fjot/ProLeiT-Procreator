import * as tslib_1 from "tslib";
import { Injectable, Optional, Inject, NgZone } from '@angular/core';
import { ApolloClient, } from 'apollo-client';
import { from } from 'rxjs';
import { QueryRef } from './QueryRef';
import { APOLLO_OPTIONS } from './tokens';
import { fromPromise, wrapWithZone, fixObservable } from './utils';
export class ApolloBase {
    constructor(ngZone, _client) {
        this.ngZone = ngZone;
        this._client = _client;
    }
    watchQuery(options) {
        return new QueryRef(this.client.watchQuery(Object.assign({}, options)), this.ngZone);
    }
    query(options) {
        return fromPromise(() => this.client.query(Object.assign({}, options)));
    }
    mutate(options) {
        return fromPromise(() => this.client.mutate(Object.assign({}, options)));
    }
    subscribe(options, extra) {
        const obs = from(fixObservable(this.client.subscribe(Object.assign({}, options))));
        return extra && extra.useZone !== true
            ? obs
            : wrapWithZone(obs, this.ngZone);
    }
    getClient() {
        return this._client;
    }
    setClient(client) {
        if (this._client) {
            throw new Error('Client has been already defined');
        }
        this._client = client;
    }
    get client() {
        this.beforeEach();
        return this._client;
    }
    beforeEach() {
        this.checkInstance();
    }
    checkInstance() {
        if (!this._client) {
            throw new Error('Client has not been defined yet');
        }
    }
}
let Apollo = class Apollo extends ApolloBase {
    constructor(_ngZone, apolloOptions) {
        super(_ngZone);
        this._ngZone = _ngZone;
        this.map = new Map();
        if (apolloOptions) {
            this.createDefault(apolloOptions);
        }
    }
    create(options, name) {
        if (name && name !== 'default') {
            this.createNamed(name, options);
        }
        else {
            this.createDefault(options);
        }
    }
    default() {
        return this;
    }
    use(name) {
        if (name === 'default') {
            return this.default();
        }
        return this.map.get(name);
    }
    createDefault(options) {
        if (this.getClient()) {
            throw new Error('Apollo has been already created.');
        }
        return this.setClient(new ApolloClient(options));
    }
    createNamed(name, options) {
        if (this.map.has(name)) {
            throw new Error(`Client ${name} has been already created`);
        }
        this.map.set(name, new ApolloBase(this._ngZone, new ApolloClient(options)));
    }
};
Apollo = tslib_1.__decorate([
    Injectable(),
    tslib_1.__param(1, Optional()),
    tslib_1.__param(1, Inject(APOLLO_OPTIONS)),
    tslib_1.__metadata("design:paramtypes", [NgZone, Object])
], Apollo);
export { Apollo };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXBvbGxvLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYXBvbGxvLWFuZ3VsYXIvIiwic291cmNlcyI6WyJBcG9sbG8udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBQyxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDbkUsT0FBTyxFQUNMLFlBQVksR0FRYixNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBQWEsSUFBSSxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBRXRDLE9BQU8sRUFBQyxRQUFRLEVBQUMsTUFBTSxZQUFZLENBQUM7QUFFcEMsT0FBTyxFQUFDLGNBQWMsRUFBQyxNQUFNLFVBQVUsQ0FBQztBQUN4QyxPQUFPLEVBQUMsV0FBVyxFQUFFLFlBQVksRUFBRSxhQUFhLEVBQUMsTUFBTSxTQUFTLENBQUM7QUFFakUsTUFBTSxPQUFPLFVBQVU7SUFDckIsWUFDVSxNQUFjLEVBQ2QsT0FBbUM7UUFEbkMsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUNkLFlBQU8sR0FBUCxPQUFPLENBQTRCO0lBQzFDLENBQUM7SUFFRyxVQUFVLENBQVcsT0FBNkI7UUFDdkQsT0FBTyxJQUFJLFFBQVEsQ0FDakIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLG1CQUFXLE9BQU8sRUFBMkIsRUFDbkUsSUFBSSxDQUFDLE1BQU0sQ0FDWixDQUFDO0lBQ0osQ0FBQztJQUVNLEtBQUssQ0FDVixPQUF3QjtRQUV4QixPQUFPLFdBQVcsQ0FBdUIsR0FBRyxFQUFFLENBQzVDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxtQkFBVyxPQUFPLEVBQUUsQ0FDdEMsQ0FBQztJQUNKLENBQUM7SUFFTSxNQUFNLENBQ1gsT0FBOEI7UUFFOUIsT0FBTyxXQUFXLENBQWlCLEdBQUcsRUFBRSxDQUN0QyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sbUJBQVcsT0FBTyxFQUFFLENBQ3ZDLENBQUM7SUFDSixDQUFDO0lBRU0s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O0NBQ0YsQ0FBQTtBQS9EWSxNQUFNO0lBRGxCLFVBQVUsRUFBRTtJQVNSLG1CQUFBLFFBQVEsRUFBRSxDQUFBO0lBQ1YsbUJBQUEsTUFBTSxDQUFDLGNBQWMsQ0FBQyxDQUFBOzZDQUZOLE1BQU07R0FQZCxNQUFNLENBK0RsQjtTQS9EWSxNQUFNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtJbmplY3RhYmxlLCBPcHRpb25hbCwgSW5qZWN0LCBOZ1pvbmV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgQXBvbGxvQ2xpZW50LFxuICBRdWVyeU9wdGlvbnMsXG4gIFdhdGNoUXVlcnlPcHRpb25zLFxuICBNdXRhdGlvbk9wdGlvbnMsXG4gIEFwb2xsb1F1ZXJ5UmVzdWx0LFxuICBTdWJzY3JpcHRpb25PcHRpb25zLFxuICBBcG9sbG9DbGllbnRPcHRpb25zLFxuICBPYnNlcnZhYmxlUXVlcnksXG59IGZyb20gJ2Fwb2xsby1jbGllbnQnO1xuaW1wb3J0IHtGZXRjaFJlc3VsdH0gZnJvbSAnYXBvbGxvLWxpbmsnO1xuaW1wb3J0IHtPYnNlcnZhYmxlLCBmcm9tfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHtRdWVyeVJlZn0gZnJvbSAnLi9RdWVyeVJlZic7XG5pbXBvcnQge0V4dHJhU3Vic2NyaXB0aW9uT3B0aW9ucywgUn0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQge0FQT0xMT19PUFRJT05TfSBmcm9tICcuL3Rva2Vucyc7XG5pbXBvcnQge2Zyb21Qcm9taXNlLCB3cmFwV2l0aFpvbmUsIGZpeE9ic2VydmFibGV9IGZyb20gJy4vdXRpbHMnO1xuXG5leHBvcnQgY2xhc3MgQXBvbGxvQmFzZTxUQ2FjaGVTaGFwZSA9IGFueT4ge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIG5nWm9uZTogTmdab25lLFxuICAgIHByaXZhdGUgX2NsaWVudD86IEFwb2xsb0NsaWVudDxUQ2FjaGVTaGFwZT4sXG4gICkge31cblxuICBwdWJsaWMgd2F0Y2hRdWVyeTxULCBWID0gUj4ob3B0aW9uczogV2F0Y2hRdWVyeU9wdGlvbnM8Vj4pOiBRdWVyeVJlZjxULCBWPiB7XG4gICAgcmV0dXJuIG5ldyBRdWVyeVJlZjxULCBWPihcbiAgICAgIHRoaXMuY2xpZW50LndhdGNoUXVlcnk8VCwgVj4oey4uLm9wdGlvbnN9KSBhcyBPYnNlcnZhYmxlUXVlcnk8VCwgVj4sXG4gICAgICB0aGlzLm5nWm9uZSxcbiAgICApO1xuICB9XG5cbiAgcHVibGljIHF1ZXJ5PFQsIFYgPSBSPihcbiAgICBvcHRpb25zOiBRdWVyeU9wdGlvbnM8Vj4sXG4gICk6IE9ic2VydmFibGU8QXBvbGxvUXVlcnlSZXN1bHQ8VD4+IHtcbiAgICByZXR1cm4gZnJvbVByb21pc2U8QXBvbGxvUXVlcnlSZXN1bHQ8VD4+KCgpID0+XG4gICAgICB0aGlzLmNsaWVudC5xdWVyeTxULCBWPih7Li4ub3B0aW9uc30pLFxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgbXV0YXRlPFQsIFYgPSBSPihcbiAgICBvcHRpb25zOiBNdXRhdGlvbk9wdGlvbnM8VCwgVj4sXG4gICk6IE9ic2VydmFibGU8RmV0Y2hSZXN1bHQ8VD4+IHtcbiAgICByZXR1cm4gZnJvbVByb21pc2U8RmV0Y2hSZXN1bHQ8VD4+KCgpID0+XG4gICAgICB0aGlzLmNsaWVudC5tdXRhdGU8VCwgVj4oey4uLm9wdGlvbnN9KSxcbiAgICApO1xuICB9XG5cbiAgcHVibGljIHN1YnNjcmliZTxULCBWID0gUj4oXG4gICAgb3B0aW9uczogU3Vic2NyaXB0aW9uT3B0aW9uczxWPixcbiAgICBleHRyYT86IEV4dHJhU3Vic2NyaXB0aW9uT3B0aW9ucyxcbiAgKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCBvYnMgPSBmcm9tKGZpeE9ic2VydmFibGUodGhpcy5jbGllbnQuc3Vic2NyaWJlPFQsIFY+KHsuLi5vcHRpb25zfSkpKTtcblxuICAgIHJldHVybiBleHRyYSAmJiBleHRyYS51c2Vab25lICE9PSB0cnVlXG4gICAgICA/IG9ic1xuICAgICAgOiB3cmFwV2l0aFpvbmUob2JzLCB0aGlzLm5nWm9uZSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0Q2xpZW50KCkge1xuICAgIHJldHVybiB0aGlzLl9jbGllbnQ7XG4gIH1cblxuICBwdWJsaWMgc2V0Q2xpZW50KGNsaWVudDogQXBvbGxvQ2xpZW50PFRDYWNoZVNoYXBlPikge1xuICAgIGlmICh0aGlzLl9jbGllbnQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2xpZW50IGhhcyBiZWVuIGFscmVhZHkgZGVmaW5lZCcpO1xuICAgIH1cblxuICAgIHRoaXMuX2NsaWVudCA9IGNsaWVudDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0IGNsaWVudCgpOiBBcG9sbG9DbGllbnQ8VENhY2hlU2hhcGU+IHtcbiAgICB0aGlzLmJlZm9yZUVhY2goKTtcblxuICAgIHJldHVybiB0aGlzLl9jbGllbnQ7XG4gIH1cblxuICBwcml2YXRlIGJlZm9yZUVhY2goKTogdm9pZCB7XG4gICAgdGhpcy5jaGVja0luc3RhbmNlKCk7XG4gIH1cblxuICBwcml2YXRlIGNoZWNrSW5zdGFuY2UoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLl9jbGllbnQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2xpZW50IGhhcyBub3QgYmVlbiBkZWZpbmVkIHlldCcpO1xuICAgIH1cbiAgfVxufVxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQXBvbGxvIGV4dGVuZHMgQXBvbGxvQmFzZTxhbnk+IHtcbiAgcHJpdmF0ZSBtYXA6IE1hcDxzdHJpbmcsIEFwb2xsb0Jhc2U8YW55Pj4gPSBuZXcgTWFwPFxuICAgIHN0cmluZyxcbiAgICBBcG9sbG9CYXNlPGFueT5cbiAgPigpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgX25nWm9uZTogTmdab25lLFxuICAgIEBPcHRpb25hbCgpXG4gICAgQEluamVjdChBUE9MTE9fT1BUSU9OUylcbiAgICBhcG9sbG9PcHRpb25zPzogQXBvbGxvQ2xpZW50T3B0aW9uczxhbnk+LFxuICApIHtcbiAgICBzdXBlcihfbmdab25lKTtcblxuICAgIGlmIChhcG9sbG9PcHRpb25zKSB7XG4gICAgICB0aGlzLmNyZWF0ZURlZmF1bHQoYXBvbGxvT3B0aW9ucyk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGNyZWF0ZTxUQ2FjaGVTaGFwZT4oXG4gICAgb3B0aW9uczogQXBvbGxvQ2xpZW50T3B0aW9uczxUQ2FjaGVTaGFwZT4sXG4gICAgbmFtZT86IHN0cmluZyxcbiAgKTogdm9pZCB7XG4gICAgaWYgKG5hbWUgJiYgbmFtZSAhPT0gJ2RlZmF1bHQnKSB7XG4gICAgICB0aGlzLmNyZWF0ZU5hbWVkPFRDYWNoZVNoYXBlPihuYW1lLCBvcHRpb25zKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5jcmVhdGVEZWZhdWx0PFRDYWNoZVNoYXBlPihvcHRpb25zKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZGVmYXVsdCgpOiBBcG9sbG9CYXNlPGFueT4ge1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcHVibGljIHVzZShuYW1lOiBzdHJpbmcpOiBBcG9sbG9CYXNlPGFueT4ge1xuICAgIGlmIChuYW1lID09PSAnZGVmYXVsdCcpIHtcbiAgICAgIHJldHVybiB0aGlzLmRlZmF1bHQoKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMubWFwLmdldChuYW1lKTtcbiAgfVxuXG4gIHB1YmxpYyBjcmVhdGVEZWZhdWx0PFRDYWNoZVNoYXBlPihcbiAgICBvcHRpb25zOiBBcG9sbG9DbGllbnRPcHRpb25zPFRDYWNoZVNoYXBlPixcbiAgKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuZ2V0Q2xpZW50KCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQXBvbGxvIGhhcyBiZWVuIGFscmVhZHkgY3JlYXRlZC4nKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5zZXRDbGllbnQobmV3IEFwb2xsb0NsaWVudDxUQ2FjaGVTaGFwZT4ob3B0aW9ucykpO1xuICB9XG5cbiAgcHVibGljIGNyZWF0ZU5hbWVkPFRDYWNoZVNoYXBlPihcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgb3B0aW9uczogQXBvbGxvQ2xpZW50T3B0aW9uczxUQ2FjaGVTaGFwZT4sXG4gICk6IHZvaWQge1xuICAgIGlmICh0aGlzLm1hcC5oYXMobmFtZSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ2xpZW50ICR7bmFtZX0gaGFzIGJlZW4gYWxyZWFkeSBjcmVhdGVkYCk7XG4gICAgfVxuICAgIHRoaXMubWFwLnNldChcbiAgICAgIG5hbWUsXG4gICAgICBuZXcgQXBvbGxvQmFzZSh0aGlzLl9uZ1pvbmUsIG5ldyBBcG9sbG9DbGllbnQ8VENhY2hlU2hhcGU+KG9wdGlvbnMpKSxcbiAgICApO1xuICB9XG59XG4iXX0=